#!/bin/bash

echo "$0: START"

set -x
set -e

## example:
#[[ -v SOURCE_WIKI_URL ]] || SOURCE_WIKI_URL='https://www.whonix.org/w'

## These variables should be set by the calling script as environment variables.
[[ -v SOURCE_WIKI_URL ]] || missing_variable missing variable SOURCE_WIKI_URL! For example: SOURCE_WIKI_URL='https://www.whonix.org/w'
[[ -v SOURCE_TARGET_API ]] || SOURCE_TARGET_API="${SOURCE_WIKI_URL}/api.php"

## XXX
WIKI_URL="$SOURCE_WIKI_URL"

source /usr/share/mediawiki-shell/common
source /usr/share/mediawiki-shell/wiki-config

echo "$0: INFO: SOURCE_WIKI_URL  : $SOURCE_WIKI_URL"
echo "$0: INFO: SOURCE_TARGET_API: $SOURCE_TARGET_API"

WIKI_URL="$SOURCE_WIKI_URL" mw-logout
WIKI_URL="$SOURCE_WIKI_URL" mw-login

## TODO: loop
# SOURCE_WIKI_URL="$SOURCE_WIKI_URL" \
#    mw-all-pages "$allpages_file"

## TODO: Do not hardcode file name
flagged_revs_api_info_result=$( \
   $curl \
      --fail \
      --retry-connrefused \
      --retry 3 \
      --retry-delay 5 \
      --silent \
      "${SOURCE_TARGET_API}?format=json&action=query&prop=info%7Cflagged&titles=File:10b.png"
)

lastrevid=$(echo "$flagged_revs_api_info_result" | jq -r ".query.pages[].lastrevid")

## TODO: check lastrevid isnum

## --location not needed and not good?
## --compressed ?
$curl \
   --fail \
   --silent \
   --show-error \
   --retry-connrefused \
   --retry 3 \
   --retry-delay 5 \
   --cookie "$cookie_jar" \
   --cookie-jar "$cookie_jar" \
   --keepalive-time 60 \
   --header "Content-Type: application/json" \
   --header "Accept-Language: en-GB" \
   --header "Connection: keep-alive" \
   --output "${TMPFOLDER}/csrf_token.json" \
   --request "POST" \
   "${SOURCE_TARGET_API}?action=query&meta=tokens&type=csrf&format=json"

echo "$0: INFO: Token received."

cat ${TMPFOLDER}/csrf_token.json | jq

csrf_token=$(cat "${TMPFOLDER}/csrf_token.json" | jq --raw-output '.query.tokens.csrftoken')

## not login-token
#csrf_token=$(cat "${TMPFOLDER}/login-token.json" | jq --raw-output '.query.tokens.csrftoken')

## Sensitive?
#echo "INFO: XXX csrf_token: $csrf_token"

comment="mediawiki-shell-bot-flagged-revisions-mass-approve"

$curl \
   --fail \
   --retry-connrefused \
   --retry 3 \
   --retry-delay 5 \
   --cookie "$cookie_jar" \
   --cookie-jar "$cookie_jar" \
   --output "${TMPFOLDER}/review-result.json" \
   --silent \
   --data-urlencode "token=${csrf_token}" \
   "${SOURCE_TARGET_API}?format=json&action=review&revid=${lastrevid}&flag_accuracy=1&comment=${comment}"

cat "${TMPFOLDER}/review-result.json" | jq

review_result=$(cat "${TMPFOLDER}/review-result.json" | jq --raw-output '.review.result')

if [ "$review_result" = "Success" ]; then
   echo "$0: Success."
   echo "$0: END"
   exit 0
fi

echo "$0: Error." >&2
echo "$0: END" >&2
exit 1
