#!/bin/bash

#set -x
set -e

## TODO: no root check

link_result_cleaned="$1"
if [ "$link_result_cleaned" = "" ]; then
   echo "$0: ERROR: No link given!"
   exit 1
fi

## NOTE: does not support spaces
replace_list=$(echo "\
<pre>http:// http://
<pre>https:// https://
<nowiki>http:// http://
<nowiki>https:// https://
<u>[http:// http://
<u>[https:// https://
\"[https:// https://
([https:// https://
([http:// http://
(http:// http://
(https:// https://
[https:// https://
[http:// http://
<ref>http:// http://
<ref>https:// https://
<code>http:// http://
<code>https:// https://
{{Code2|http:// http://
{{Code2|https:// https://
</ref>
{{link|link=
{{Link|link=
https://</code>.
https://</code>
")

while read -r replace_config_line ; do
   if [ "$replace_config_line" = "" ]; then
      echo "ERROR! replace_config_line is empty!"
      exit 1
   fi

   true "replace_config_line: '$replace_config_line'"
   read -r first second <<< "$replace_config_line"

   true "first: $first"
   true "second: $second"

   if [ "$first" = "" ]; then
      echo "ERROR! first is empty!"
      exit 1
   fi
   #if [ "$second" = "" ]; then
      #echo "ERROR! second is empty!"
      #exit 1
   #fi

   link_result_cleaned=$(echo "$link_result_cleaned" | LANG=C str_replace "$first" "$second" 2>/dev/null)
done < <( echo "$replace_list" )

while read -r replace_config_line ; do
   if [ "$replace_config_line" = "" ]; then
      echo "ERROR! replace_config_line is empty!"
      exit 1
   fi

   true "replace_config_line: '$replace_config_line'"
   read -r first second <<< "$replace_config_line"

   true "first: $first"
   true "second: $second"

   if [ "$first" = "" ]; then
      echo "ERROR! first is empty!"
      exit 1
   fi
   #if [ "$second" = "" ]; then
      #echo "ERROR! second is empty!"
      #exit 1
   #fi

   link_result_cleaned=$(echo "$link_result_cleaned" | LANG=C str_replace "$first" "$second" 2>/dev/null)
done < <( echo "$replace_list" )

## NOTE: does not support spaces?
grep_skip_fixed_string_list=$(echo "\
|image=
https://web.archive.org
{{Stable
{{project
tor+https
tor+http
https://www.gnu.org/licenses
load.php
?useformat=mobile
?action=purge
https://www.whonix.org
https://www.kicksecure.com
GPLv3
")

for grep_skip_fixed_string_item in $grep_skip_fixed_string_list ; do
   if echo "$link_result_cleaned" | grep --quiet --fixed-string --ignore-case "$grep_skip_fixed_string_item" ; then
      exit 0
   fi
done

## '<ref name=f_secure>https://blog.f-secure.com/cold-boot-attacks/'
if echo "$link_result_cleaned" | grep --quiet --fixed-string --ignore-case "name=" ; then
   longest_match_after_character=">"
   link_result_cleaned="${link_result_cleaned#*$longest_match_after_character}"
fi

if [ "$link_result_cleaned" = "https://" ]; then
   exit 0
fi
if [ "$link_result_cleaned" = "http://" ]; then
   exit 0
fi
if [ "$link_result_cleaned" = "()" ]; then
   exit 0
fi

echo "$link_result_cleaned"
