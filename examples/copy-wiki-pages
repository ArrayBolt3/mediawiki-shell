#!/bin/bash
set -x
echo "$0: START"

set -e
cd ..

source common

## example:
#SOURCE_WIKI_URL='https://www.kicksecure.com'
#DESTINATION_WIKI_URL=(
#   'https://www.whonix.org'
#)

[[ -v SOURCE_WIKI_URL ]] || missing_variable SOURCE_WIKI_URL
[[ -v DESTINATION_WIKI_URL ]] || missing_variable DESTINATION_WIKI_URL
[[ -v copy_wiki_pages_item ]] || missing_variable copy_wiki_pages_item

# WIKI_URL="$DESTINATION_WIKI_URL" \
#    ./login

echo "$0: INFO: Fetching '$SOURCE_WIKI_URL' '$copy_wiki_pages_item'..."

rm -f "$TMPFOLDER/fetched-wiki-page"
touch "$TMPFOLDER/fetched-wiki-page"
test -w "$TMPFOLDER/fetched-wiki-page"

WIKI_URL="$SOURCE_WIKI_URL" \
   ./fetch \
      "$copy_wiki_pages_item" | \
      tee "$TMPFOLDER/fetched-wiki-page" >/dev/null

test -r "$TMPFOLDER/fetched-wiki-page"

#cat "$TMPFOLDER/fetched-wiki-page"
#echo ""

echo "$0: INFO: Fetch success."

wiki_source_api="${SOURCE_WIKI_URL}/api.php"

page_pending_status_json=$(\
   curl \
   --fail \
   --retry-connrefused \
   --retry 3 \
   --retry-delay 5 \
   --silent \
   "${wiki_source_api}?format=json&action=query&prop=info%7Cflagged&titles=$copy_wiki_pages_item"
)

if echo "$page_pending_status_json" | jq | grep pending_since ; then
   echo "$0: WARNING: Fetching '$SOURCE_WIKI_URL' '$copy_wiki_pages_item' has PENDING EDITS!"
   exit 2
fi

echo "$0: INFO: No pending edits, ok."

wiki_page_content=$(cat "$TMPFOLDER/fetched-wiki-page")

WIKI_URL="$DESTINATION_WIKI_URL" \
   ./edit "$copy_wiki_pages_item" "$TMPFOLDER/fetched-wiki-page"
