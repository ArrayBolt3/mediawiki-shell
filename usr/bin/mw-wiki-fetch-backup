#!/bin/bash

error_out_maybe() {
   if [ "$wiki_error_on_fetch" = "true" ]; then
      ## error out
      return 1
   else
      ## ignore error
      return 0
   fi
}

echo "$0: START"

set -e

source /usr/share/mediawiki-shell/common

## example:
#[[ -v SOURCE_WIKI_URL ]] || SOURCE_WIKI_URL='https://www.whonix.org/w'
#[[ -v wiki_backup_folder ]] || wiki_backup_folder=~/mediawiki-shell/whonix-wiki-backup"

## These variables should be set by the calling script as environment variables.
[[ -v SOURCE_WIKI_URL ]] || missing_variable SOURCE_WIKI_URL
[[ -v wiki_backup_folder ]] || missing_variable wiki_backup_folder
[[ -v wiki_error_on_fetch ]] || wiki_error_on_fetch=true

allpages_file="${TMPFOLDER}/allpages.txt"
rm -f "$allpages_file"

echo "$0: INFO: TMPFOLDER         : $TMPFOLDER"
echo "$0: INFO: wiki_backup_folder: $wiki_backup_folder"
echo "$0: INFO: SOURCE_WIKI_URL: $SOURCE_WIKI_URL"

mkdir -p "$wiki_backup_folder"

if ! test -d "$wiki_backup_folder" ; then
   echo "$0: ERROR: wiki_backup_folder '$wiki_backup_folder' does not exist! Run...?:"
   echo "mkdir --parents '$wiki_backup_folder'"
   exit 1
fi

if ! test -w "$wiki_backup_folder" ; then
   echo "$0: ERROR: wiki_backup_folder '$wiki_backup_folder' unwriteable! Run...?:"
   echo "chown --recursive '$USER:$USER' '$wiki_backup_folder'"
   exit 1
fi

## Not required for public wiki.
#mw-logout
#mw-login

SOURCE_WIKI_URL="$SOURCE_WIKI_URL" \
   mw-all-pages "$allpages_file"

test -r "$allpages_file"

counter_total="$(cat "$allpages_file" | wc -l)"

counter_currently=0
while IFS=$'\n' read -r item_from_all_pages ; do
   counter_currently=$(( $counter_currently + 1 ))

   backup_page_item="$item_from_all_pages"
   ## remove last letter ("'")
   backup_page_item="${backup_page_item::-1}"
   ## remove first letter ("'")
   backup_page_item="${backup_page_item:1}"

   search="'\''"
   replace="'"
   backup_page_item=$(echo "$backup_page_item" | str_replace "$search" "$replace")

   search="&"
   replace="%26"
   backup_page_item=$(echo "$backup_page_item" | str_replace "$search" "$replace")

   ## Same format as git-mediawiki: replace ' ' with '_'.
   ## Replace spaces with underscore.
   search=" "
   replace="_"
   backup_page_item=$(echo "$backup_page_item" | str_replace "$search" "$replace")

   backup_filename_item="$backup_page_item"

   ## Same format as git-mediawiki: replace '/' with '%2F'.
   ## Also the file system does not accept files containing '/'.
   search="/"
   replace="%2F"
   backup_filename_item=$(echo "$backup_filename_item" | str_replace "$search" "$replace")

   ## Same format as git-mediawiki: add '.mw' file extension.
   backup_filename_item="${backup_filename_item}.mw"
   echo "$counter_currently / $counter_total | $backup_page_item | $backup_filename_item"

   for retry_counter in 1 2 3 4 ; do
      WIKI_URL="$SOURCE_WIKI_URL" \
         mw-fetch \
            "$backup_page_item" | \
            tee "${wiki_backup_folder}/${backup_filename_item}" \
            >/dev/null
   done

   ## TODO
   ## || error_out_maybe

   ## Same format as git-mediawiki: add newline at the end.
   #echo "" | tee -a "${wiki_backup_folder}/${backup_filename_item}" >/dev/null

done < "$allpages_file"
