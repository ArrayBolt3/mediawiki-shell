#!/bin/bash

set -e
source /usr/share/mediawiki-shell/common
source /usr/share/mediawiki-shell/wiki-config

echo "$0: INFO: Logging out of $WIKI_API... Requesting CSRF token..."

rm -f "${TMPFOLDER}/logout-token.json"

## --location?
## --compressed?
## --keepalive-time 60?
$curl \
   $curl_opts \
   --cookie "$cookie_jar" \
   --cookie-jar "$cookie_jar" \
   --header "Content-Type: application/json" \
   --header "Accept-Language: en-GB" \
   --header "Connection: keep-alive" \
   --output "${TMPFOLDER}/logout-token.json" \
   --request "POST" \
   "${WIKI_API}?action=query&meta=tokens&type=csrf&format=json"

echo "$0: INFO: Token received."

csrf_token=$(cat "${TMPFOLDER}/logout-token.json" | jq --raw-output '.query.tokens.csrftoken')

## --location not needed and not good?
## --compressed?
## --keepalive-time 60?
$curl \
   $curl_opts \
   --cookie "$cookie_jar" \
   --cookie-jar "$cookie_jar" \
   --header "Accept-Language: en-GB" \
   --header "Connection: keep-alive" \
   --data-urlencode "token=${csrf_token}" \
   --output "${TMPFOLDER}/logout.json" \
   --request "POST" \
   "${WIKI_API}?action=logout&format=json"

if [ $(cat "${TMPFOLDER}/logout.json") = "{}" ] ; then
   echo "$0: INFO: OK, logged out."
   exit 0
fi

cat "${TMPFOLDER}/logout.json" | jq
echo "$0: ERROR: Logout failed!"
exit 1
