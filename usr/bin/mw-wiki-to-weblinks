#!/bin/bash

#set -x
set -e

## TODO: no root check

test -d ~/sourcesown/wiki-backup/kicksecure-wiki-backup
test -d ~/sourcesown/wiki-backup/whonix-wiki-backup

files_list=""
files_list+=~/sourcesown/wiki-backup/kicksecure-wiki-backup/*.mw
files_list+=" "
files_list+=~/sourcesown/wiki-backup/whonix-wiki-backup/*.mw

total=0
for file_name in $files_list ; do
   total=$(( total + 1 ))
done

counter=0
for file_name in $files_list ; do
   counter=$(( counter + 1 ))
   #echo "$counter / $total | file_name: '$(basename "$file_name")'"
   test -r "$file_name"

   web_links_list=$(dm-file-to-weblinks "$file_name")
   for web_link_item in $web_links_list ; do
      web_link_cleaned=$(dm-wiki-link-clean "$web_link_item")
      if [ "$web_link_cleaned" = "" ]; then
         continue
      fi

      #echo "$web_link_cleaned"

      ## Thanks to:
      ## Dennis Williamson
      ## https://stackoverflow.com/users/26428/dennis-williamson
      ## https://stackoverflow.com/a/3184819/2605155
      regex='(https?)://[-[:alnum:]\+&@#/%?=~_|!:,.;]*[-[:alnum:]\+&@#/%=~_|]'
      string="$web_link_cleaned"
      if [[ $string =~ $regex ]]
      then
         true "Link valid: $web_link_cleaned"
      else
         echo "$counter / $total | file_name: '$(basename "$file_name")' | Link not valid: $web_link_cleaned"
      fi

   done
   #echo ""

done
